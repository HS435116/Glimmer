# Glimmer（晨曦智能打卡）

本仓库包含：
- `mobile/`：Kivy 移动端（Android/桌面调试均可）
- `server/`：FastAPI 服务端（SQLite/SQLAlchemy）

---

## 1. 功能总览

### 1.1 打卡与查询
- **打卡**：提交打卡状态（如“打卡成功/补录”等），记录时间、备注、经纬度（如有）。
- **按月查询**：支持查询整月记录。
- **月汇总展示**：按天汇总展示“每日第一次打卡 + 每日最后一次打卡”。
- **本地缓存策略**：打卡记录查询结果本地缓存 **2 个月**，自动清理多余月份缓存。

### 1.2 账号体系（服务器为准）
- **注册/登录**：账号数据以服务器为准。
- **个人资料**：姓名/电话/部门等信息以服务器为准；本地仅缓存 `profile_cache` 用于离线快速展示。
- **修改密码**：已登录用户可修改密码。
- **忘记密码**：通过注册时的密保问题找回；即使未配置服务器地址，也可在弹窗中手工输入服务器地址执行找回。

> 安全说明：服务器不保存明文密码，仅保存密码哈希；密保答案亦以哈希形式存储。

### 1.3 在线团队与管理（在线管理页）
角色分为：
- `user`：普通用户
- `admin`：管理员（仅管理权限，不含工程师权限）
- `engineer`：工程师（超级管理员）

功能点：
- **团队创建**：工程师/管理员可创建团队。
- **加入团队**：用户通过团队编号申请加入。
- **入队审核**：管理员/工程师可审核加入申请。
- **成员管理**：管理员/工程师可查看成员列表、移除成员、为成员提交补录申请等。
- **补录申请/审核**：用户可申请补录；管理员/工程师可审核，通过后自动写入“补录”打卡记录。
- **公告**：
  - 工程师：可发布全局公告
  - 管理员：可发布自己团队内公告

权限约束（重要）：
- 管理员默认 **仅可管理自己创建的团队**（只看到自己创建的团队；不能管理/删除他人创建的团队）。
- 管理员 **不能移除工程师账号**（避免误操作）；工程师可管理全部。
- 工程师标签在在线管理页 **仅工程师可见**。

### 1.4 工程师管理（仅 engineer 可见）
- **服务器用户总人数**：在工程师页顶部以红色标记展示。
- **用户ID查询**：按用户ID查询用户个人资料，弹窗展示：
  - 用户基本信息（用户名、角色、姓名、电话、部门、创建时间、最后登录时间等）
  - **最后登录 IP**（服务器记录）
  - **登录密码哈希**（服务器存储形式，非明文）
- **创建多个管理员账号**：支持 `admin/admin1/admin2...` 自动累加创建（服务端提供工程师接口）。

### 1.5 首页广告
- 首页底部广告支持：
  - **垂直滚动（上下滚动）**
  - **水平滚动（左右滚动）**
  - **静止**
- 广告配置以服务器为准，客户端轮询同步不会覆盖本机选择。

### 1.6 版本提醒
- 工程师可发布版本信息；客户端可拉取并提示。

### 1.7 团队聊天（服务器中转）
- 聊天仅通过服务器中转，不落地本地聊天缓存。
- 服务器不在线时：聊天输入会被禁用并弹窗提示，避免崩溃。
- 聊天数据保留 **31 天**，服务端自动清理。

---

## 2. 默认账号与环境变量

### 2.1 默认账号（服务端启动时自动引导）
- 工程师：
  - 用户名：`engineer`
  - 密码：`engineer123`
- 管理员：
  - 用户名：`admin`（可由工程师接口创建 `admin1/admin2...`）
  - 密码：`admin123`

### 2.2 常用环境变量（服务端）
- `GLIMMER_HOST`：监听地址（默认 `0.0.0.0`）
- `GLIMMER_PORT`：端口（默认 `8000`）
- `GLIMMER_RELOAD`：开发热重载（默认开启）
- `GLIMMER_ENGINEER_USER` / `GLIMMER_ENGINEER_PASS`：自定义工程师账号
- `GLIMMER_ADMIN_USER` / `GLIMMER_ADMIN_PASS`：自定义默认管理员账号
- `GLIMMER_APK_PATH`：指定下载 APK 的路径（可选）

---

## 3. 运行方式

### 3.1 启动服务端
```bash
cd server
python run_server.py
```

### 3.2 移动端（调试/运行）
- 依据你的本地 Kivy 运行方式执行（项目内为 Kivy App）。

### 3.3 构建 APK（Android）
```bash
cd mobile
buildozer -v android debug
```

### 3.4 推送/安装到设备
```bash
adb install -r mobile/bin/*.apk
```

---

## 4. Git 推送所有文件命令（包含 README）
> 以下仅给出命令；请在确认无误后执行。

```bash
cd d:/Users/Administrator/Glimmer
git status
git add -A
git commit -m "docs: add README and update features"
git push origin main
```
