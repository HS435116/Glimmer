# Glimmer（晨曦智能打卡）

本仓库包含：
- `mobile/`：Kivy 移动端（Android/桌面调试均可）
- `server/`：FastAPI 服务端（SQLite/SQLAlchemy）

---

## 1. 功能总览

### 1.1 打卡与查询
- **打卡**：提交打卡状态（如“打卡成功/补录”等），记录时间、备注、经纬度（如有）。
- **按月查询**：支持查询整月记录。
- **月汇总展示**：按天汇总展示“每日第一次打卡 + 每日最后一次打卡”。
- **本地缓存策略**：查询结果本地缓存最近 **2 个月**，自动清理多余月份缓存。

### 1.2 账号体系（服务器为准）
- **注册/登录**：账号数据以服务器为准。
- **个人资料**：姓名/电话/部门等信息以服务器为准；客户端可缓存用于离线快速展示。
- **修改密码**：已登录用户可修改密码。
- **忘记密码**：通过注册时的密保问题找回；支持在弹窗中手工输入服务器地址执行找回。

> 安全说明：服务器不保存明文密码，仅保存密码哈希；密保答案亦以哈希形式存储。

### 1.3 在线团队与管理（在线管理页）
角色分为：
- `user`：普通用户
- `admin`：管理员（仅管理权限，不含工程师权限）
- `engineer`：工程师（超级管理员）

功能点：
- **团队创建**：工程师/管理员可创建团队。
- **加入团队**：用户通过团队ID（6位）申请加入。
- **入队审核**：管理员/工程师可审核加入申请。
- **成员管理**：管理员/工程师可查看成员列表、移除成员、为成员提交补录申请等。
- **补录申请/审核**：用户可申请补录；管理员/工程师可审核，通过后自动写入“补录”打卡记录。
- **公告**：
  - 工程师：可发布全局公告
  - 管理员：可发布自己团队内公告

权限约束（重要）：
- 管理员默认 **仅可管理自己创建的团队**（只看到自己创建的团队）。
- 管理员 **不能移除工程师账号**（避免误操作）；工程师可管理全部。
- 工程师标签在在线管理页 **仅工程师可见**。

### 1.4 工程师管理（仅 engineer 可见）
- **服务器用户总人数**：在工程师页顶部以红色标记展示。
- **用户ID查询**：按用户ID查询用户个人资料，弹窗展示：
  - 用户基本信息（用户名、角色、姓名、电话、部门、创建时间、最后登录时间等）
  - **最后登录 IP**（服务器记录）
  - **登录密码哈希**（服务器存储形式，非明文）
- **创建管理员账号**：输入基础用户名（如 `admin`），服务端自动分配可用用户名；默认密码固定为 `admin123`。
- **清理全服数据**：工程师可执行“清理所有用户数据”（二次确认 + 输入密码），不可恢复。

### 1.5 首页广告
- 首页底部广告支持：
  - **垂直滚动（上下滚动）**
  - **水平滚动（左右滚动）**
  - **静止**
- 广告配置以服务器为准。

### 1.6 版本提醒
- 工程师可发布版本信息；客户端可拉取并提示。

### 1.7 团队聊天（服务器中转）
- 聊天通过服务器中转。
- 服务器不在线时：聊天输入会禁用并弹窗提示，避免崩溃。
- 聊天数据保留 **31 天**，服务端自动清理。

---

## 2. 用户ID规则（便于查询）
为便于统一查询，本系统约定：
- 工程师 ID：**固定 999**
- 管理员 ID：**从 1000 开始递增**
- 普通用户 ID：**从 50000 开始递增**

> 说明：该规则对“新创建账号”生效；历史数据库中的旧账号ID不会自动改号。

---

## 3. 默认账号与环境变量

### 3.1 默认账号（服务端启动时自动引导）
- 工程师：
  - 用户名：`engineer`
  - 密码：`engineer123`
- 管理员：
  - 用户名：`admin`
  - 密码：`admin123`

### 3.2 常用环境变量（服务端）
- `GLIMMER_HOST`：监听地址（默认 `0.0.0.0`）
- `GLIMMER_PORT`：端口（默认 `8000`）
- `GLIMMER_RELOAD`：开发热重载（建议生产关闭）
- `GLIMMER_ENGINEER_USER` / `GLIMMER_ENGINEER_PASS`：自定义工程师账号
- `GLIMMER_ADMIN_USER` / `GLIMMER_ADMIN_PASS`：自定义默认管理员账号
- `GLIMMER_APK_PATH`：指定下载 APK 的路径（可选）

### 3.3 数据库文件名（SQLite）
- 默认数据库文件已改为更复杂名称：
  - `server/data_7b1c0a9f3e2d4c6b.sqlite`
- 可通过环境变量覆盖：
  - `GLIMMER_DB_FILENAME`：仅指定文件名（放在 `server/` 目录下）
  - `GLIMMER_DB_PATH`：指定完整路径
  - `GLIMMER_DATABASE_URL`：指定完整 SQLAlchemy URL

> 注意：更换文件名只降低“猜文件名”的概率，不能替代真正的鉴权/权限控制。

---

## 4. 运行方式

### 4.1 启动服务端（Windows PowerShell 示例）
```powershell
cd d:\Users\Administrator\Glimmer\server
$env:GLIMMER_RELOAD="0"
C:\Users\Administrator\.conda\envs\Opencv\python.exe .\run_server.py
```

### 4.2 移动端（调试/运行）
- 依据你的本地 Kivy 运行方式执行（项目内为 Kivy App）。

### 4.3 构建 APK（Android）
```bash
cd mobile
buildozer -v android debug
```

### 4.4 推送/安装到设备
```bash
adb install -r mobile/bin/*.apk
```

---

## 5. Git 推送命令（包含新增使用须知）
> 以下仅给出命令；请在确认无误后执行。

```bash
cd d:/Users/Administrator/Glimmer
git status
git add -A
git commit -m "docs: update README and add user guide"
git push origin main
```
